<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <!-- OCR åº“ -->
    <script src='https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js'></script>
    <title>ä¸ªäººä»»åŠ¡çœ‹æ¿</title>
    <style>
        :root {
            --bg-body: #f2f3f5;
            --bg-card: #ffffff;
            --text-main: #1f2329;
            --text-sub: #8f959e;
            --radius: 12px;
            --font-scale: 1;
            
            --blue: #3370ff;
            --green: #00b665;
            --red: #f54a45;
            --orange: #ff8800;
            --purple: #9333ea;
            --border: #dee0e3;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-body);
            color: var(--text-main);
            margin: 0; padding: 15px;
            font-size: calc(14px * var(--font-scale));
            padding-bottom: 120px;
        }

        /* å¸ƒå±€ä¸æ‹–æ‹½ */
        #app-container { display: flex; flex-direction: column; gap: 15px; }
        .section-block { touch-action: pan-y; transition: transform 0.2s, opacity 0.2s; position: relative; }
        .section-block.dragging { opacity: 0.9; transform: scale(1.02); z-index: 1000; box-shadow: 0 15px 30px rgba(0,0,0,0.15); }

        /* å¡ç‰‡ */
        .card {
            background: var(--bg-card);
            border-radius: var(--radius);
            padding: 15px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.04);
            border: 1px solid var(--border);
        }

        /* æ§ä»¶ */
        .btn { border: none; border-radius: var(--radius); padding: 8px 16px; font-size: 0.95em; font-weight: bold; cursor: pointer; display: inline-flex; align-items: center; justify-content: center; transition: opacity 0.2s; white-space: nowrap;}
        .btn:active { opacity: 0.8; }
        .btn-primary { background: var(--blue); color: white; }
        .btn-outline { border: 1px solid var(--border); background: transparent; color: var(--text-main); }
        .btn-text { background: transparent; color: var(--text-sub); }
        
        input, textarea { 
            border: 1px solid var(--border); border-radius: var(--radius); 
            padding: 10px; font-size: 1em; background: var(--bg-card); 
            width: 100%; outline: none; transition: border-color 0.2s; font-family: inherit;
        }
        input:focus, textarea:focus { border-color: var(--blue); }

        /* æ— ç¼è¾“å…¥æ¡† */
        .seamless-input {
            border: 1px solid transparent; background: transparent; padding: 2px 4px; margin: -2px; width: 100%;
        }
        .seamless-input:focus { border: 1px solid var(--blue); background: #fff; border-radius: 4px; }

        /* é¡¶éƒ¨æ  */
        .top-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .app-title { font-weight: 800; font-size: 1.4em; }
        .sys-time { font-size: 0.9em; color: var(--text-sub); font-family: monospace; font-weight: bold; }

        /* è‡ªå®šä¹‰ä¸‹æ‹‰èœå• */
        .custom-select { position: relative; cursor: pointer; user-select: none; min-width: 90px; }
        .select-trigger { border: 1px solid var(--border); border-radius: var(--radius); padding: 8px 10px; background: var(--bg-card); display: flex; justify-content: space-between; align-items: center; font-size: 0.9em; white-space: nowrap; overflow: hidden;}
        .select-trigger::after { content: 'â–¼'; font-size: 0.6em; color: #999; margin-left: 6px; }
        .select-options { position: absolute; top: 105%; left: 0; min-width: 100%; background: var(--bg-card); border: 1px solid var(--border); border-radius: var(--radius); box-shadow: 0 5px 15px rgba(0,0,0,0.1); z-index: 100; display: none; max-height: 250px; overflow-y: auto; }
        .select-options.open { display: block; }
        .select-option { padding: 10px; font-size: 0.9em; border-bottom: 1px solid #f5f5f5; display: flex; align-items: center; gap: 6px; }

        /* KPI & Charts */
        .kpi-row { display: flex; gap: 10px; }
        .kpi-item { flex: 1; text-align: center; }
        .big-num { font-size: 1.8em; font-weight: 800; line-height: 1.2; }
        .label-text { font-size: 0.8em; color: var(--text-sub); margin-top: 4px; }
        
        .charts-container { display: flex; flex-direction: column; gap: 20px; }
        .chart-section-title { font-size: 0.9em; font-weight: bold; border-left: 3px solid var(--blue); padding-left: 8px; margin-bottom: 8px;}
        .pie-row { display: flex; gap: 10px; overflow-x: auto; padding-bottom: 5px; }
        .pie-card { flex: 1; min-width: 110px; background: #f9f9f9; padding: 10px; border-radius: var(--radius); display: flex; flex-direction: column; align-items: center; border: 1px solid #eee; }
        .pie-chart { width: 60px; height: 60px; border-radius: 50%; border: 2px solid #fff; margin-bottom: 8px; flex-shrink: 0; }
        .legend-box { display: flex; flex-direction: column; gap: 4px; width: 100%; }
        .legend-item { display: flex; align-items: center; gap: 5px; font-size: 0.7em; color: #666; }
        .legend-color { width: 8px; height: 8px; border-radius: 2px; flex-shrink: 0; }
        
        .bar-chart-row { display: flex; gap: 10px; height: 140px; }
        .bar-box { flex: 1; background: #f9f9f9; border-radius: var(--radius); padding: 10px; display: flex; flex-direction: column; border: 1px solid #eee; }
        .bar-area { flex: 1; display: flex; align-items: flex-end; gap: 6px; margin-bottom: 5px; border-bottom: 1px solid #e0e0e0; padding-bottom: 2px; }
        .bar-col { flex: 1; height: 100%; display: flex; flex-direction: column; justify-content: flex-end; align-items: center; }
        .bar-fill { width: 100%; min-height: 4px; border-radius: calc(var(--radius) * 0.4) calc(var(--radius) * 0.4) 0 0; transition: height 0.3s; opacity: 0.9; }
        .bar-legend-row { display: flex; flex-wrap: wrap; gap: 8px; justify-content: center; }

        /* ä»»åŠ¡åˆ—è¡¨ */
        .filter-row { display: flex; gap: 8px; margin-bottom: 12px; }
        .task-item { padding: 12px; border-bottom: 1px solid #f0f0f0; display: flex; flex-direction: column; gap: 6px; }
        .task-header { display: flex; justify-content: space-between; align-items: flex-start; gap: 10px; }
        .task-title-input { font-size: 1.05em; font-weight: 500; border: none; background: transparent; padding: 0; width: 100%; }
        .task-title-input.done { text-decoration: line-through; color: #ccc; }
        
        .task-meta { display: flex; align-items: center; gap: 5px; font-size: 0.8em; color: #999; margin-top:2px; }
        
        .task-ctrls { display: flex; gap: 8px; align-items: center; flex-wrap: wrap; margin-top: 4px; }
        .mini-select .select-trigger { padding: 3px 8px; font-size: 0.8em; min-width: auto; height: 26px; }
        
        .subtasks { margin-top: 5px; padding-left: 10px; border-left: 2px solid #eee; display: none; }
        .subtasks.show { display: block; }
        .sub-item { display: flex; align-items: center; gap: 8px; margin-top: 6px; font-size: 0.9em; }

        /* ç¬”è®° & ç¯ç®± */
        .note-preview-area { display: flex; gap: 10px; flex-wrap: wrap; margin: 10px 0; }
        .note-thumb { height: 60px; border-radius: 6px; border: 1px solid #eee; cursor: zoom-in; object-fit: cover; }
        .note-item { margin-bottom: 12px; padding: 12px; background: #f9f9f9; border-radius: 8px; border: 1px solid #eee; }
        .note-edit-area { width: 100%; background: transparent; border: none; resize: vertical; font-size: 0.95em; line-height: 1.5; font-family: inherit; }
        .note-edit-area:focus { background: #fff; outline: 1px solid var(--blue); border-radius: 4px; }
        
        .lightbox { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 3000; display: none; justify-content: center; align-items: center; cursor: zoom-out; }
        .lightbox img { max-width: 95%; max-height: 95%; border-radius: 4px; box-shadow: 0 0 20px rgba(0,0,0,0.5); }

        /* é¢œè‰² */
        .bg-p1 { background: #fee2e2; color: #dc2626; } 
        .bg-p2 { background: #dbeafe; color: #2563eb; } 
        .bg-p3 { background: #fef3c7; color: #d97706; } 
        .bg-p4 { background: #f3f4f6; color: #4b5563; }
        .bg-work { background: #eff6ff; color: var(--blue); } 
        .bg-study { background: #f3e8ff; color: var(--purple); } 
        .bg-life { background: #dcfce7; color: var(--green); }
        .bg-todo { background: #f5f5f5; color: #666; } 
        .bg-doing { background: #e0edff; color: var(--blue); }
        .bg-done { background: #dcfce7; color: var(--green); }

        /* è®¾ç½®å¼¹çª— */
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: none; justify-content: center; align-items: flex-end; z-index: 2000; }
        .modal-content { background: #fff; width: 100%; border-radius: 20px 20px 0 0; padding: 25px; animation: slideUp 0.3s; max-height: 80vh; overflow-y: auto; }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }

    </style>
</head>
<body>

    <!-- ç¯ç®± -->
    <div class="lightbox" id="lightbox" onclick="this.style.display='none'">
        <img id="lightbox-img" src="" alt="Full View">
    </div>

    <!-- é¡¶éƒ¨ -->
    <div class="top-bar">
        <div class="app-title">ä¸ªäººä»»åŠ¡çœ‹æ¿</div>
        <div class="sys-time" id="sys-clock">00:00:00</div>
        <button class="btn btn-text" style="font-size:1.4em" onclick="openSettings()">âš™ï¸</button>
    </div>

    <div id="app-container">
        
        <!-- 1. KPI -->
        <div class="section-block" id="sec-kpi">
            <div class="card">
                <div class="kpi-row">
                    <div class="kpi-item">
                        <div class="label-text">å¾…åŠ</div>
                        <div class="big-num" style="color:#999" id="kpi-todo">0</div>
                    </div>
                    <div class="kpi-item">
                        <div class="label-text">è¿›è¡Œä¸­</div>
                        <div class="big-num" style="color:var(--blue)" id="kpi-doing">0</div>
                    </div>
                    <div class="kpi-item">
                        <div class="label-text">å·²å®Œæˆ</div>
                        <div class="big-num" style="color:var(--green)" id="kpi-done">0</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 2. å›¾è¡¨ -->
        <div class="section-block" id="sec-chart">
            <div class="card charts-container">
                <div>
                    <div class="chart-section-title">å¤šç»´åˆ†å¸ƒ</div>
                    <div class="pie-row">
                        <div class="pie-card"><div class="pie-chart" id="pie-tag"></div><div class="legend-box" id="leg-tag"></div></div>
                        <div class="pie-card"><div class="pie-chart" id="pie-cat"></div><div class="legend-box" id="leg-cat"></div></div>
                        <div class="pie-card"><div class="pie-chart" id="pie-status"></div><div class="legend-box" id="leg-status"></div></div>
                    </div>
                </div>
                <div class="bar-chart-row">
                    <div class="bar-box">
                        <div class="chart-section-title">çŠ¶æ€ç»Ÿè®¡</div>
                        <div class="bar-area" id="bar-status-chart"></div>
                        <div class="bar-legend-row" id="bar-status-leg"></div>
                    </div>
                    <div class="bar-box">
                        <div class="chart-section-title">ç´§æ€¥åº¦ç»Ÿè®¡</div>
                        <div class="bar-area" id="bar-urgency-chart"></div>
                        <div class="bar-legend-row" id="bar-urgency-leg"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 3. æ·»åŠ ä»»åŠ¡ (è‡ªåŠ¨æ—¶é—´ç‰ˆ) -->
        <div class="section-block" id="sec-add">
            <div class="card">
                <div style="font-weight:bold; margin-bottom:10px">âš¡ å¿«é€Ÿæ·»åŠ </div>
                <div style="display:flex; gap:10px; margin-bottom:10px">
                    <input type="text" id="add-title" placeholder="è¦åšä»€ä¹ˆï¼Ÿ(è‡ªåŠ¨è®°å½•å½“å‰æ—¶é—´)" style="flex:2">
                    <button class="btn btn-primary" onclick="addTask()">æ·»åŠ </button>
                </div>
                <!-- æ—¥æœŸæ—¶é—´é€‰æ‹©å·²ç§»é™¤ï¼Œåå°è‡ªåŠ¨æŠ“å– -->
                <div style="display:flex; gap:10px">
                    <div class="custom-select" id="sel-add-tag" style="flex:1"></div>
                    <div class="custom-select" id="sel-add-cat" style="flex:1"></div>
                </div>
            </div>
        </div>

        <!-- 4. ç¬”è®° (å‹ç¼©ä¿®å¤ç‰ˆ) -->
        <div class="section-block" id="sec-note">
            <div class="card">
                <div style="font-weight:bold; margin-bottom:8px">çµæ„Ÿ / ç¬”è®° / æˆªå›¾</div>
                <textarea id="note-input" rows="3" placeholder="å†™ç‚¹ä»€ä¹ˆï¼Œæˆ–ç²˜è´´å›¾ç‰‡ (å·²å¯ç”¨æ™ºèƒ½å‹ç¼©)..."></textarea>
                <div id="note-preview-area" class="note-preview-area"></div>
                <div style="display:flex; gap:8px; align-items:center; margin-top:5px">
                    <input type="file" id="img-upload" accept="image/*" style="display:none" onchange="handleImgUpload(this)">
                    <button class="btn btn-outline" style="padding:5px 10px; font-size:0.85em" onclick="document.getElementById('img-upload').click()">ğŸ“· å›¾ç‰‡</button>
                    <button class="btn btn-outline" style="padding:5px 10px; font-size:0.85em" onclick="doOCR()">ğŸ” è¯†åˆ«</button>
                    <div style="flex:1"></div>
                    <button class="btn btn-primary" style="padding:5px 15px" onclick="addNote()">ä¿å­˜è®°å½•</button>
                </div>
                <div id="note-list" style="margin-top:15px; border-top:1px solid #eee; padding-top:10px"></div>
            </div>
        </div>

        <!-- 5. åˆ—è¡¨ (è‡ªåŠ¨æ›´æ–°æ—¶é—´) -->
        <div class="section-block" id="sec-list">
            <div class="card">
                <div style="font-weight:bold; margin-bottom:10px">ä»»åŠ¡æ˜ç»†</div>
                <div class="filter-row">
                    <div class="custom-select mini-select" id="filter-tag" style="flex:1"></div>
                    <div class="custom-select mini-select" id="filter-cat" style="flex:1"></div>
                    <div class="custom-select mini-select" id="filter-status" style="flex:1"></div>
                </div>
                <div id="task-list"></div>
            </div>
        </div>

    </div>

    <!-- è®¾ç½® -->
    <div class="modal" id="settings-modal" onclick="if(event.target===this) closeSettings()">
        <div class="modal-content">
            <h3 style="margin-top:0">å…¨å±€è®¾ç½®</h3>
            <div class="setting-item">
                <button class="btn btn-outline" style="width:100%; margin-bottom:10px" onclick="exportData()">ğŸ“¤ å¯¼å‡ºæ•°æ®å¤‡ä»½</button>
                <button class="btn btn-outline" style="width:100%" onclick="document.getElementById('file-import').click()">ğŸ“¥ å¯¼å…¥æ•°æ®æ¢å¤</button>
                <input type="file" id="file-import" style="display:none" onchange="importData(this)">
            </div>
            <div class="setting-item">
                <label>èƒŒæ™¯é¢œè‰²</label><input type="color" id="bg-color-picker" oninput="setBgColor(this.value)" style="height:40px">
            </div>
            <div class="setting-item">
                <label>å¡ç‰‡é¢œè‰²</label><input type="color" id="card-color-picker" oninput="setCardColor(this.value)" style="height:40px">
            </div>
            <div class="setting-item">
                <label>åœ†è§’</label><input type="range" min="0" max="25" step="1" id="radius-range" style="width:100%" oninput="setRadius(this.value)">
            </div>
            <button class="btn btn-primary" style="width:100%" onclick="closeSettings()">å®Œæˆ</button>
        </div>
    </div>

    <script>
        /* --- åŸºç¡€é…ç½® --- */
        const COLORS = {
            p1: '#f54a45', p2: '#3370ff', p3: '#ff8800', p4: '#999',
            work: '#3370ff', study: '#9333ea', life: '#00b665',
            todo: '#ccc', doing: '#3370ff', done: '#00b665'
        };

        const OPT_TAG = [
            {v:'p1', t:'ğŸ”´ é‡è¦ä¸”ç´§æ€¥', c:'bg-p1', col:COLORS.p1}, {v:'p2', t:'ğŸ”µ é‡è¦ä¸ç´§æ€¥', c:'bg-p2', col:COLORS.p2},
            {v:'p3', t:'ğŸŸ  ä¸é‡è¦ç´§æ€¥', c:'bg-p3', col:COLORS.p3}, {v:'p4', t:'âšª æ™®é€šä»»åŠ¡', c:'bg-p4', col:COLORS.p4}
        ];
        const OPT_CAT = [
            {v:'work', t:'ğŸ’¼ å·¥ä½œ', c:'bg-work', col:COLORS.work}, {v:'study', t:'ğŸ“š å­¦ä¹ ', c:'bg-study', col:COLORS.study},
            {v:'life', t:'ğŸ  ç”Ÿæ´»', c:'bg-life', col:COLORS.life}
        ];
        const OPT_STATUS = [
            {v:'todo', t:'æœªå¼€å§‹', c:'bg-todo', col:COLORS.todo}, {v:'doing', t:'è¿›è¡Œä¸­', c:'bg-doing', col:COLORS.doing},
            {v:'done', t:'å·²å®Œæˆ', c:'bg-done', col:COLORS.done}
        ];

        /* --- å˜é‡ --- */
        let tasks = JSON.parse(localStorage.getItem('v5_tasks')) || [];
        let notes = JSON.parse(localStorage.getItem('v5_notes')) || [];
        let config = JSON.parse(localStorage.getItem('v5_config')) || {
            bgColor: '#f2f3f5', cardColor: '#ffffff', radius: 12, font: 1, order: []
        };
        let filters = { tag:'all', cat:'all', status:'all' };
        let tempImg = null;

        function init() {
            applyConfig();
            setupDrag();
            setupClock();
            
            // ä¸‹æ‹‰åˆå§‹åŒ–
            renderSelect('sel-add-tag', OPT_TAG, 'p4');
            renderSelect('sel-add-cat', OPT_CAT, 'life');
            
            // ç­›é€‰åˆå§‹åŒ–
            const mkF = (a,t) => [{v:'all',t:t,c:'',col:'#ccc'}].concat(a);
            renderSelect('filter-tag', mkF(OPT_TAG,'å…¨éƒ¨æ ‡ç­¾'), 'all', v=>{filters.tag=v;renderList()});
            renderSelect('filter-cat', mkF(OPT_CAT,'å…¨éƒ¨ç±»åˆ«'), 'all', v=>{filters.cat=v;renderList()});
            renderSelect('filter-status', mkF(OPT_STATUS,'å…¨éƒ¨çŠ¶æ€'), 'all', v=>{filters.status=v;renderList()});
            
            // ç²˜è´´ç›‘å¬
            document.getElementById('note-input').addEventListener('paste', handlePaste);
            
            renderAll();
        }

        /* --- æ ¸å¿ƒæ¸²æŸ“ --- */
        function renderAll() {
            renderKPI();
            renderCharts();
            renderList();
            renderNotes();
        }

        function renderKPI() {
            const count = s => tasks.filter(t=>t.status===s).length;
            document.getElementById('kpi-todo').innerText = count('todo');
            document.getElementById('kpi-doing').innerText = count('doing');
            document.getElementById('kpi-done').innerText = count('done');
        }

        function renderCharts() {
            const calc = (arr,k) => arr.reduce((a,c)=>{a[c[k]]=(a[c[k]]||0)+1;return a},{});
            const dTag = calc(tasks,'tag');
            const dCat = calc(tasks,'cat');
            const dSts = calc(tasks,'status');
            
            drawPie('pie-tag','leg-tag',dTag,OPT_TAG);
            drawPie('pie-cat','leg-cat',dCat,OPT_CAT);
            drawPie('pie-status','leg-status',dSts,OPT_STATUS);
            drawBar('bar-status-chart','bar-status-leg',dSts,OPT_STATUS);
            drawBar('bar-urgency-chart','bar-urgency-leg',dTag,OPT_TAG);
        }

        function drawPie(cid,lid,data,opts) {
            const total = tasks.length||1;
            let stops=[], curr=0, leg='';
            opts.forEach(o => {
                const c = data[o.v]||0;
                if(c>0) {
                    const pct=(c/total)*100;
                    stops.push(`${o.col} ${curr}% ${curr+pct}%`);
                    curr+=pct;
                }
                leg += `<div class="legend-item"><div class="legend-color" style="background:${o.col}"></div><div>${o.t.split(' ')[1]||o.t}</div></div>`;
            });
            const grad = stops.length ? `conic-gradient(${stops.join(', ')})` : `conic-gradient(#eee 0% 100%)`;
            document.getElementById(cid).style.background = grad;
            document.getElementById(lid).innerHTML = leg;
        }

        function drawBar(cid,lid,data,opts) {
            const el=document.getElementById(cid), leg=document.getElementById(lid);
            el.innerHTML=''; leg.innerHTML='';
            const max = Math.max(...Object.values(data))||1;
            opts.forEach(o => {
                const c=data[o.v]||0;
                const h=(c/max)*100;
                el.innerHTML += `<div class="bar-col"><div class="bar-fill" style="height:${h}%; background:${o.col}"></div></div>`;
                leg.innerHTML += `<div class="legend-item"><div class="legend-color" style="background:${o.col}"></div><div>${o.t.split(' ')[1]||o.t}</div></div>`;
            });
        }

        function renderList() {
            const list = document.getElementById('task-list');
            list.innerHTML = '';
            
            let res = tasks.filter(t => 
                (filters.tag==='all'||t.tag===filters.tag) &&
                (filters.cat==='all'||t.cat===filters.cat) &&
                (filters.status==='all'||t.status===filters.status)
            );
            const score = {doing:0, todo:1, done:2};
            res.sort((a,b)=> score[a.status]-score[b.status] || a.tag.localeCompare(b.tag));

            res.forEach(t => {
                const i = tasks.indexOf(t);
                const div = document.createElement('div');
                div.className = 'task-item';
                
                // å­ä»»åŠ¡HTML
                let subHtml = '';
                if(t.sub && t.sub.length) {
                    subHtml = `<div class="subtasks ${t.showSub?'show':''}">${t.sub.map((s,si)=>`
                        <div class="sub-item">
                            <input type="checkbox" ${s.done?'checked':''} onchange="toggleSub(${i},${si})">
                            <input class="seamless-input" value="${s.text}" onchange="updateSub(${i},${si},this.value)" style="text-decoration:${s.done?'line-through':'none'};color:${s.done?'#ccc':'inherit'}">
                        </div>
                    `).join('')}</div>`;
                }

                div.innerHTML = `
                    <div class="task-header">
                        <input class="task-title-input seamless-input ${t.status==='done'?'done':''}" value="${t.name}" onchange="updateTask(${i},'name',this.value)">
                        <button onclick="delTask(${i})" style="border:none;background:none;color:#ccc;font-size:1.2em">Ã—</button>
                    </div>
                    <div class="task-meta">
                        <!-- çº¯æ–‡æœ¬æ˜¾ç¤ºæ—¥æœŸæ—¶é—´ï¼Œè‡ªåŠ¨æ›´æ–°ï¼Œä¸å¯æ‰‹åŠ¨é€‰ -->
                        <span>ğŸ“… ${t.date}</span> <span>â° ${t.time}</span>
                    </div>
                    <div class="task-ctrls">
                        <div class="custom-select mini-select" id="s-tag-${i}"></div>
                        <div class="custom-select mini-select" id="s-cat-${i}"></div>
                        <div class="custom-select mini-select" id="s-sts-${i}"></div>
                        <button class="btn btn-text" style="font-size:0.8em;border:1px solid #eee" onclick="toggleSubBox(${i})">ğŸ“‹ ${t.sub.length}</button>
                        <button class="btn btn-text" style="color:var(--blue);font-size:1.2em" onclick="promptSub(${i})">+</button>
                    </div>
                    ${subHtml}
                `;
                list.appendChild(div);
                renderSelect(`s-tag-${i}`, OPT_TAG, t.tag, v=>updateTask(i,'tag',v));
                renderSelect(`s-cat-${i}`, OPT_CAT, t.cat, v=>updateTask(i,'cat',v));
                renderSelect(`s-sts-${i}`, OPT_STATUS, t.status, v=>updateTask(i,'status',v));
            });
        }

        function renderNotes() {
            const el = document.getElementById('note-list');
            el.innerHTML = notes.map((n, i) => `
                <div class="note-item">
                    <div style="font-size:0.8em; color:#999; display:flex; justify-content:space-between; margin-bottom:5px">
                        <span>${n.date} ${n.time}</span>
                        <span onclick="delNote(${i})" style="color:#ff4d4f; cursor:pointer">åˆ é™¤</span>
                    </div>
                    <textarea class="note-edit-area" onchange="updateNote(${i},this.value)" rows="${n.text.split('\n').length || 1}">${n.text}</textarea>
                    ${n.img ? `<img src="${n.img}" class="note-thumb" onclick="viewImage(this.src)" style="margin-top:8px">` : ''}
                </div>
            `).join('');
        }

        /* --- æ™ºèƒ½å›¾ç‰‡å‹ç¼© (å…³é”®ä¿®å¤) --- */
        function compressImage(fileOrBlob) {
            return new Promise((resolve) => {
                const reader = new FileReader();
                reader.readAsDataURL(fileOrBlob);
                reader.onload = (event) => {
                    const img = new Image();
                    img.src = event.target.result;
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        const MAX_WIDTH = 800; // é™åˆ¶æœ€å¤§å®½åº¦
                        let width = img.width;
                        let height = img.height;

                        if (width > MAX_WIDTH) {
                            height *= MAX_WIDTH / width;
                            width = MAX_WIDTH;
                        }

                        canvas.width = width;
                        canvas.height = height;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, width, height);
                        
                        // å‹ç¼©ä¸º JPEGï¼Œè´¨é‡ 0.7
                        const dataUrl = canvas.toDataURL('image/jpeg', 0.7);
                        resolve(dataUrl);
                    };
                };
            });
        }

        /* --- ä¸šåŠ¡é€»è¾‘ --- */
        function getNow() {
            const now = new Date();
            return {
                d: now.toISOString().split('T')[0],
                t: now.toTimeString().slice(0,5)
            };
        }

        function addTask() {
            const title = document.getElementById('add-title').value;
            if(!title) return alert('è¯·è¾“å…¥ä»»åŠ¡å†…å®¹');
            const now = getNow();
            
            tasks.unshift({
                id: Date.now(), name: title, 
                date: now.d, time: now.t,
                tag: document.getElementById('sel-add-tag').dataset.val,
                cat: document.getElementById('sel-add-cat').dataset.val,
                status: 'todo', sub: [], showSub: false
            });
            document.getElementById('add-title').value='';
            save(); renderAll();
        }

        function updateTask(i, k, v) { 
            tasks[i][k] = v; 
            // åªè¦ä¿®æ”¹äº†å†…å®¹ï¼Œå°±è‡ªåŠ¨æ›´æ–°æ—¶é—´
            const now = getNow();
            tasks[i].date = now.d;
            tasks[i].time = now.t;
            save(); renderList(); 
        }

        function delTask(i) { if(confirm('åˆ é™¤?')) { tasks.splice(i,1); save(); renderAll(); } }
        
        async function addNote() {
            const txt = document.getElementById('note-input').value;
            if(!txt && !tempImg) return;
            const now = getNow();
            
            // å°è¯•ä¿å­˜ï¼Œå¦‚æœ LocalStorage æ»¡äº†ï¼Œæ•è·é”™è¯¯
            try {
                notes.unshift({
                    id: Date.now(), text: txt, img: tempImg, // tempImg å·²ç»æ˜¯å‹ç¼©è¿‡çš„äº†
                    date: now.d, time: now.t
                });
                save(); 
                document.getElementById('note-input').value='';
                document.getElementById('note-preview-area').innerHTML='';
                tempImg=null;
                renderNotes();
            } catch(e) {
                alert('å­˜å‚¨ç©ºé—´ä¸è¶³ï¼å³ä½¿å‹ç¼©åå›¾ç‰‡ä¾ç„¶è¿‡å¤§ï¼Œå»ºè®®æ¸…ç†æ—§ç¬”è®°æˆ–ä»…ä¿å­˜æ–‡å­—ã€‚');
                notes.shift(); // ç§»é™¤åˆšåˆšæ·»åŠ å¤±è´¥çš„
            }
        }

        function updateNote(i, val) { 
            notes[i].text = val; 
            const now = getNow();
            notes[i].date = now.d; notes[i].time = now.t;
            save(); 
        }
        function delNote(i) { if(confirm('åˆ é™¤ç¬”è®°?')){ notes.splice(i,1); save(); renderNotes(); } }

        /* å›¾ç‰‡ä¸Šä¼ ä¸ç²˜è´´å¤„ç† (é›†æˆå‹ç¼©) */
        async function handleImgUpload(inp) {
            if(inp.files[0]) {
                tempImg = await compressImage(inp.files[0]);
                document.getElementById('note-preview-area').innerHTML=`<img src="${tempImg}" class="note-thumb" onclick="viewImage(this.src)">`;
            }
        }
        async function handlePaste(e) {
            for(let item of e.clipboardData.items) {
                if(item.type.startsWith('image')) {
                    tempImg = await compressImage(item.getAsFile());
                    document.getElementById('note-preview-area').innerHTML=`<img src="${tempImg}" class="note-thumb" onclick="viewImage(this.src)">`;
                }
            }
        }

        function viewImage(src) {
            document.getElementById('lightbox-img').src = src;
            document.getElementById('lightbox').style.display = 'flex';
        }
        
        async function doOCR() {
            if(!tempImg) return alert('è¯·å…ˆä¸Šä¼ å›¾ç‰‡');
            const btn=document.querySelector('button[onclick="doOCR()"]');
            const old=btn.innerText; btn.innerText='è¯†åˆ«ä¸­...';
            try{
                const {data:{text}} = await Tesseract.recognize(tempImg,'chi_sim');
                document.getElementById('note-input').value += '\n' + text;
            }catch(e){alert('OCRéœ€è”ç½‘');}
            btn.innerText=old;
        }

        // å­ä»»åŠ¡
        function toggleSubBox(i){tasks[i].showSub=!tasks[i].showSub;renderList();}
        function promptSub(i){const t=prompt('å­ä»»åŠ¡');if(t){tasks[i].sub.push({text:t,done:false});tasks[i].showSub=true;save();renderList();}}
        function toggleSub(ti,si){tasks[ti].sub[si].done=!tasks[ti].sub[si].done;save();renderList();}
        function updateSub(ti,si,v){tasks[ti].sub[si].text=v;save();}

        /* --- è¾…åŠ© --- */
        function save() {
            localStorage.setItem('v5_tasks', JSON.stringify(tasks));
            localStorage.setItem('v5_notes', JSON.stringify(notes));
            localStorage.setItem('v5_config', JSON.stringify(config));
        }
        function setupClock() { setInterval(()=>document.getElementById('sys-clock').innerText=new Date().toLocaleTimeString(),1000); }
        function setupDrag() {
            const con=document.getElementById('app-container');
            let timer, dragEl;
            document.querySelectorAll('.section-block').forEach(el=>{
                el.addEventListener('touchstart',e=>{
                    if(['INPUT','BUTTON','TEXTAREA'].includes(e.target.tagName)) return;
                    timer=setTimeout(()=>{ dragEl=el; el.classList.add('dragging'); navigator.vibrate?.(50); },600);
                },{passive:true});
                el.addEventListener('touchmove',e=>{
                    if(!dragEl) { clearTimeout(timer); return; }
                    e.preventDefault();
                    const t=document.elementFromPoint(e.touches[0].clientX,e.touches[0].clientY)?.closest('.section-block');
                    if(t && t!==dragEl && con.contains(t)) {
                        const all=[...con.children];
                        all.indexOf(dragEl)<all.indexOf(t) ? t.after(dragEl) : t.before(dragEl);
                    }
                },{passive:false});
                el.addEventListener('touchend',()=>{ clearTimeout(timer); if(dragEl){dragEl.classList.remove('dragging');config.order=[...con.children].map(c=>c.id);save();} dragEl=null; });
            });
            if(config.order) config.order.forEach(id=>con.appendChild(document.getElementById(id)));
        }

        /* --- ä¸‹æ‹‰èœå•ç»„ä»¶ --- */
        function renderSelect(id, opts, val, cb) {
            const el=document.getElementById(id); if(!el) return;
            const cur=opts.find(o=>o.v===val)||opts[0];
            el.innerHTML=`<div class="select-trigger ${cur.c}" onclick="toggleSelect('${id}')">${cur.t}</div>
                <div class="select-options">${opts.map(o=>`<div class="select-option" onclick="selectOption('${id}','${o.v}')"><span class="color-dot" style="background:${o.col}"></span>${o.t}</div>`).join('')}</div>`;
            el.dataset.val=val; el.onchangeCallback=cb;
        }
        function toggleSelect(id) {
            document.querySelectorAll('.select-options').forEach(e=>e.parentElement.id!==id&&e.classList.remove('open'));
            document.querySelector(`#${id} .select-options`).classList.toggle('open');
        }
        function selectOption(id,v) {
            const el=document.getElementById(id); el.dataset.val=v;
            document.querySelector(`#${id} .select-options`).classList.remove('open');
            if(el.onchangeCallback) el.onchangeCallback(v);
            if(id.startsWith('sel-add')) {
                const opts=id.includes('tag')?OPT_TAG:OPT_CAT;
                const cur=opts.find(o=>o.v===v);
                el.querySelector('.select-trigger').className=`select-trigger ${cur.c}`;
                el.querySelector('.select-trigger').innerHTML=cur.t;
            }
        }
        document.addEventListener('click',e=>{if(!e.target.closest('.custom-select'))document.querySelectorAll('.select-options').forEach(x=>x.classList.remove('open'))});

        /* --- è®¾ç½® & æ•°æ®å¤‡ä»½ --- */
        function openSettings(){document.getElementById('settings-modal').style.display='flex';}
        function closeSettings(){document.getElementById('settings-modal').style.display='none';save();}
        
        function exportData() {
            const name = prompt("è¯·è¾“å…¥å¤‡ä»½æ–‡ä»¶å:", "backup_" + new Date().toISOString().slice(0,10));
            if(!name) return;
            const blob=new Blob([JSON.stringify({tasks,notes,config})],{type:'application/json'});
            const a=document.createElement('a');
            a.href=URL.createObjectURL(blob);
            a.download=`${name}.json`;
            a.click();
        }
        
        function importData(inp) {
            const f=inp.files[0]; if(!f) return;
            const r=new FileReader();
            r.onload=e=>{
                try {
                    const d=JSON.parse(e.target.result);
                    if(d.tasks) tasks=d.tasks;
                    if(d.notes) notes=d.notes;
                    if(d.config) config=d.config;
                    save(); location.reload();
                } catch(er){ alert('å¯¼å…¥å¤±è´¥ï¼šæ–‡ä»¶æ ¼å¼ä¸æ­£ç¡®'); }
            };
            r.readAsText(f);
        }

        function applyConfig(){
            const r=document.documentElement.style;
            r.setProperty('--bg-body',config.bgColor);r.setProperty('--bg-card',config.cardColor);
            r.setProperty('--radius',config.radius+'px');r.setProperty('--font-scale',config.font);
            document.getElementById('bg-color-picker').value=config.bgColor;
            document.getElementById('card-color-picker').value=config.cardColor;
            document.getElementById('radius-range').value=config.radius;
        }
        function setBgColor(v){config.bgColor=v;applyConfig();}
        function setCardColor(v){config.cardColor=v;applyConfig();}
        function setRadius(v){config.radius=v;applyConfig();}

        init();
    </script>
</body>
</html>