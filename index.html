<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>快记板</title>
    <!-- 引入样式表 -->
    <link rel="stylesheet" href="style.css">
    <!-- 引入 OCR 库 -->
    <script src='https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js'></script>
</head>
<body>
    <!-- 图片查看灯箱 -->
    <div class="lightbox" id="lightbox" onclick="closeLightbox()">
        <img id="lightbox-img" src="">
    </div>

    <!-- 自定义通用弹窗 -->
    <div class="custom-modal-overlay" id="custom-modal" onclick="closeCustomModal(event)">
        <div class="custom-modal-content">
            <h3 id="modal-title">标题</h3>
            <div id="modal-body"></div>
            <div class="modal-footer">
                <button class="btn btn-text" onclick="closeCustomModal()" data-i18n="btn_cancel">取消</button>
                <button class="btn btn-primary" id="modal-confirm-btn" data-i18n="btn_confirm">确定</button>
            </div>
        </div>
    </div>

    <!-- 视口包裹器 -->
    <div id="viewport-wrapper">
        
        <!-- 顶部栏 -->
        <div class="top-bar">
            <!-- 修改点：默认值改为 快记板 -->
            <input type="text" id="app-title-input" class="app-title-edit" value="快记板" onchange="updateAppTitle(this.value)">
            <div class="sys-time" id="sys-clock">00:00:00</div>
            <button class="btn btn-text icon-btn" onclick="openSettings()">⚙️</button>
        </div>

        <div id="app-container">
            
            <!-- 1. KPI 数据看板 -->
            <div class="section-block" id="sec-kpi">
                <div class="card">
                    <button class="pin-btn" onclick="togglePin('sec-kpi')">📌</button>
                    <div class="kpi-row">
                        <div class="kpi-item" onclick="handleKPIClick('todo')">
                            <div class="label-text" data-i18n="todo">待办</div>
                            <div class="big-num" style="color:#999" id="kpi-todo">0</div>
                        </div>
                        <div class="kpi-item" onclick="handleKPIClick('doing')">
                            <div class="label-text" data-i18n="doing">进行中</div>
                            <div class="big-num" style="color:var(--blue)" id="kpi-doing">0</div>
                        </div>
                        <div class="kpi-item" onclick="handleKPIClick('done')">
                            <div class="label-text" data-i18n="done">已完成</div>
                            <div class="big-num" style="color:var(--green)" id="kpi-done">0</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 2. 图表统计 -->
            <div class="section-block" id="sec-chart">
                <div class="card charts-container">
                    <button class="pin-btn" onclick="togglePin('sec-chart')">📌</button>
                    <div>
                        <div class="chart-sec-title" data-i18n="dist">多维分布</div>
                        <div class="pie-row">
                            <div class="pie-card"><div class="pie-chart" id="pie-tag"></div><div class="legend-box" id="leg-tag"></div></div>
                            <div class="pie-card"><div class="pie-chart" id="pie-cat"></div><div class="legend-box" id="leg-cat"></div></div>
                            <div class="pie-card"><div class="pie-chart" id="pie-status"></div><div class="legend-box" id="leg-status"></div></div>
                        </div>
                    </div>
                    <div class="bar-chart-row">
                        <div class="bar-box"><div class="chart-sec-title" data-i18n="stat_status">状态统计</div><div class="bar-area" id="bar-status-chart"></div><div class="bar-legend-row" id="bar-status-leg"></div></div>
                        <div class="bar-box"><div class="chart-sec-title" data-i18n="stat_urgency">紧急度统计</div><div class="bar-area" id="bar-urgency-chart"></div><div class="bar-legend-row" id="bar-urgency-leg"></div></div>
                    </div>
                </div>
            </div>

            <!-- 3. 快速添加 -->
            <div class="section-block" id="sec-add">
                <div class="card">
                    <button class="pin-btn" onclick="togglePin('sec-add')">📌</button>
                    <div style="font-weight:bold; margin-bottom:10px" data-i18n="add_title">⚡ 快速添加</div>
                    <div style="display:flex; gap:10px; margin-bottom:10px">
                        <input type="text" id="add-title" style="flex:2" data-i18n-ph="add_ph">
                        <button class="btn btn-primary" onclick="addTask()" data-i18n="btn_add">添加</button>
                    </div>
                    <div style="display:flex; gap:10px">
                        <div class="custom-select" id="sel-add-tag" style="flex:1"></div>
                        <div class="custom-select" id="sel-add-cat" style="flex:1"></div>
                    </div>
                </div>
            </div>

            <!-- 4. 笔记与灵感 -->
            <div class="section-block" id="sec-note">
                <div class="card">
                    <button class="pin-btn" onclick="togglePin('sec-note')">📌</button>
                    <div style="font-weight:bold; margin-bottom:8px" data-i18n="note_title">灵感 / 笔记 / 截图</div>
                    <textarea id="note-input" rows="3" data-i18n-ph="note_ph"></textarea>
                    <div id="note-preview-area" class="note-preview-area"></div>
                    <div class="note-toolbar">
                        <input type="file" id="img-upload" accept="image/*" style="display:none" onchange="handleImgUpload(this)">
                        <button class="btn btn-outline btn-icon-text" onclick="document.getElementById('img-upload').click()">
                            <span>📷</span> <span data-i18n="btn_img">图片</span>
                        </button>
                        <button class="btn btn-outline btn-icon-text" onclick="doOCR()" id="btn-ocr">
                            <span>🔍</span> <span data-i18n="btn_ocr">识别</span>
                        </button>
                        <div style="flex:1"></div>
                        <button class="btn btn-primary" onclick="addNote()" data-i18n="btn_save">保存</button>
                    </div>
                    <div id="note-list" style="margin-top:15px; border-top:1px solid #eee; padding-top:10px"></div>
                </div>
            </div>

            <!-- 5. 任务列表 -->
            <div class="section-block" id="sec-list">
                <div class="card">
                    <div style="font-weight:bold; margin-bottom:10px" data-i18n="list_title">任务明细</div>
                    <div class="filter-row">
                        <div class="custom-select mini-select" id="filter-tag" style="flex:1"></div>
                        <div class="custom-select mini-select" id="filter-cat" style="flex:1"></div>
                        <div class="custom-select mini-select" id="filter-status" style="flex:1"></div>
                    </div>
                    <div id="task-list"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- 设置面板 -->
    <div class="custom-modal-overlay" id="settings-modal" onclick="if(event.target===this) closeSettings()">
        <div class="custom-modal-content settings-content">
            <h3 style="margin-top:0" data-i18n="set_title">全局设置</h3>
            
            <div class="setting-item">
                <label class="setting-label">PC页面宽度</label>
                <input type="range" min="375" max="1200" step="10" id="width-range" style="width:100%" oninput="setPcWidth(this.value)">
                <div style="font-size:0.8em; color:#999; text-align:right"><span id="width-val">600</span>px</div>
            </div>

            <div class="setting-item">
                <label class="setting-label" data-i18n="set_lang">语言 / Language</label>
                <select id="lang-select" onchange="changeLang(this.value)" style="width:100%"><option value="zh">🇨🇳 中文</option><option value="en">🇺🇸 English</option><option value="jp">🇯🇵 日本語</option><option value="fr">🇫🇷 Français</option><option value="es">🇪🇸 Español</option></select>
            </div>

            <div class="setting-item">
                <label class="setting-label" data-i18n="set_backup">数据管理</label>
                <div style="display:flex; gap:10px">
                    <button class="btn btn-outline" style="flex:1" onclick="promptExport()">📤 <span data-i18n="btn_export">导出备份</span></button>
                    <button class="btn btn-outline" style="flex:1" onclick="document.getElementById('file-import').click()">📥 <span data-i18n="btn_import">导入恢复</span></button>
                    <input type="file" id="file-import" style="display:none" onchange="importData(this)">
                </div>
            </div>

            <div class="setting-item">
                <label class="setting-label" data-i18n="set_font">字体大小</label><input type="range" min="0.8" max="1.3" step="0.05" id="font-range" style="width:100%" oninput="setFont(this.value)">
            </div>
            
            <div class="setting-item">
                <label class="setting-label" data-i18n="set_radius">圆角大小</label><input type="range" min="0" max="25" step="1" id="radius-range" style="width:100%" oninput="setRadius(this.value)">
            </div>

            <div class="setting-item">
                <label class="setting-label" data-i18n="set_color">自定义颜色</label>
                <div style="display:flex; gap:15px; align-items:center;">
                    <span data-i18n="col_bg">背景</span> <input type="color" id="bg-color-picker" oninput="setBgColor(this.value)" style="height:30px">
                    <span data-i18n="col_card">卡片</span> <input type="color" id="card-color-picker" oninput="setCardColor(this.value)" style="height:30px">
                </div>
            </div>
            
            <button class="btn btn-primary" style="width:100%" onclick="closeSettings()" data-i18n="btn_close">完成</button>
        </div>
    </div>

    <script src="script.js"></script>
</body>
</html>